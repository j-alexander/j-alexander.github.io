---
layout: post
title: "RdKafka Subscription in F#"
date: 2016-12-08
comments: false
publish: false
---
<h2>Objective</h2>
<p>We want to use the RdKafka library from F#. etc</p>
<h2>Dependencies</h2>
<ol>
<li>
<p><em>RdKafka</em> from NuGet, or using Paket:</p>
<table class="pre"><tr><td class="snippet"><pre class="fssnip"><code lang="powershell">./.paket/paket.exe add nuget RdKafka project MyProject
</code></pre></td></tr></table>
</li>
<li>
<p><em>Pre-build event</em> to transfer native libraries (64-bit):</p>
<table class="pre"><tr><td class="snippet"><pre class="fssnip"><code lang="powershell">xcopy /y /d /f
     "$(ProjectDir)..\packages\RdKafka.Internal.librdkafka\runtimes\win7-x64\native\*.*"
     "$(TargetDir)"
</code></pre></td></tr></table>
</li>
<li><p><em>Reference</em> and open the C# wrapper:</p></li>
</ol>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="prep">#r</span> <span class="s">&quot;./packages/RdKafka/lib/net451/RdKafka.dll&quot;</span>

<span class="k">open</span> <span class="i">RdKafka</span>
</code></pre>
<h2>Terminology</h2>
<h3>Kafka</h3>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span class="i">Topic</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 5)" onmouseover="showTip(event, 'fs4', 5)" class="i">string</span>
<span class="k">and</span> <span class="i">Partition</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs5', 6)" onmouseover="showTip(event, 'fs5', 6)" class="i">int</span>
<span class="k">and</span> <span class="i">Offset</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs6', 7)" onmouseover="showTip(event, 'fs6', 7)" class="i">int64</span>
<span class="k">and</span> <span class="i">ErrorReason</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 8)" onmouseover="showTip(event, 'fs4', 8)" class="i">string</span>
<span class="k">and</span> <span class="i">BrokerCsv</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 9)" onmouseover="showTip(event, 'fs4', 9)" class="i">string</span>  <span class="c">// remove protocol {http://,tcp://}</span>
<span class="k">and</span> <span class="i">ConsumerName</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 10)" onmouseover="showTip(event, 'fs4', 10)" class="i">string</span>
</code></pre>
<h3>RdKafka Events</h3>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span onmouseout="hideTip(event, 'fs7', 11)" onmouseover="showTip(event, 'fs7', 11)" class="i">Event</span> <span class="o">=</span>
  | <span class="i">Statistics</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs4', 12)" onmouseover="showTip(event, 'fs4', 12)" class="i">string</span>
  | <span class="i">OffsetCommit</span> <span class="k">of</span> <span class="i">ErrorCode</span><span class="o">*</span><span onmouseout="hideTip(event, 'fs8', 13)" onmouseover="showTip(event, 'fs8', 13)" class="i">List</span><span class="o">&lt;</span><span class="i">Topic</span><span class="o">*</span><span class="i">Partition</span><span class="o">*</span><span class="i">Offset</span><span class="o">&gt;</span>
  | <span class="i">EndReached</span> <span class="k">of</span> <span class="i">Topic</span><span class="o">*</span><span class="i">Partition</span><span class="o">*</span><span class="i">Offset</span>
  | <span class="i">PartitionsAssigned</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs8', 14)" onmouseover="showTip(event, 'fs8', 14)" class="i">List</span><span class="o">&lt;</span><span class="i">Topic</span><span class="o">*</span><span class="i">Partition</span><span class="o">*</span><span class="i">Offset</span><span class="o">&gt;</span>
  | <span class="i">PartitionsRevoked</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs8', 15)" onmouseover="showTip(event, 'fs8', 15)" class="i">List</span><span class="o">&lt;</span><span class="i">Topic</span><span class="o">*</span><span class="i">Partition</span><span class="o">*</span><span class="i">Offset</span><span class="o">&gt;</span>
  | <span class="i">ConsumerError</span> <span class="k">of</span> <span class="i">ErrorCode</span>
  | <span class="i">Error</span> <span class="k">of</span> <span class="i">ErrorCode</span><span class="o">*</span><span onmouseout="hideTip(event, 'fs4', 16)" onmouseover="showTip(event, 'fs4', 16)" class="i">string</span>
</code></pre>
<h3>Converting RdKafka Types</h3>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">ofTopicPartitionOffset</span> (<span class="i">tpo</span><span class="o">:</span><span class="i">TopicPartitionOffset</span>) <span class="o">:</span> <span class="i">Topic</span><span class="o">*</span><span class="i">Partition</span><span class="o">*</span><span class="i">Offset</span> <span class="o">=</span>
  <span class="i">tpo</span><span class="o">.</span><span class="i">Topic</span>,<span class="i">tpo</span><span class="o">.</span><span class="i">Partition</span>,<span class="i">tpo</span><span class="o">.</span><span class="i">Offset</span>
<span class="k">let</span> <span class="i">ofTopicPartitionOffsets</span> <span class="o">=</span>
  <span onmouseout="hideTip(event, 'fs9', 17)" onmouseover="showTip(event, 'fs9', 17)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs10', 18)" onmouseover="showTip(event, 'fs10', 18)" class="i">map</span> <span class="i">ofTopicPartitionOffset</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs9', 19)" onmouseover="showTip(event, 'fs9', 19)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs11', 20)" onmouseover="showTip(event, 'fs11', 20)" class="i">toList</span>
<span class="k">let</span> <span class="i">ofCommit</span> (<span class="i">oca</span><span class="o">:</span><span class="i">Consumer</span><span class="o">.</span><span class="i">OffsetCommitArgs</span>) <span class="o">:</span> <span class="i">ErrorCode</span><span class="o">*</span><span onmouseout="hideTip(event, 'fs8', 21)" onmouseover="showTip(event, 'fs8', 21)" class="i">List</span><span class="o">&lt;</span><span class="i">Topic</span><span class="o">*</span><span class="i">Partition</span><span class="o">*</span><span class="i">Offset</span><span class="o">&gt;</span> <span class="o">=</span>
  <span class="i">oca</span><span class="o">.</span><span class="i">Error</span>, <span class="i">ofTopicPartitionOffsets</span> <span class="i">oca</span><span class="o">.</span><span class="i">Offsets</span>
<span class="k">let</span> <span class="i">ofError</span> (<span class="i">ea</span><span class="o">:</span><span class="i">Handle</span><span class="o">.</span><span class="i">ErrorArgs</span>) <span class="o">=</span>
  <span class="i">ea</span><span class="o">.</span><span class="i">ErrorCode</span>, <span class="i">ea</span><span class="o">.</span><span class="i">Reason</span>
</code></pre>
<h3>Logging RdKafka Events</h3>
<p>RdKafka provides much better visibility than other .NET kafka libraries.
Let the consumer handle all of the cases that can be logged for Event types.
Consider using an exhaustive match on the Event union type.</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="c">// </span>
<span class="k">let</span> <span class="i">toLog</span> <span class="o">=</span> <span class="k">function</span>
  | <span onmouseout="hideTip(event, 'fs7', 22)" onmouseover="showTip(event, 'fs7', 22)" class="i">Event</span><span class="o">.</span><span class="i">Error</span> _ <span class="k">-&gt;</span> ()
  | _ <span class="k">-&gt;</span> ()
</code></pre>
<p>You can easily attach your <code>toLog</code> function to callbacks from both the producer and consumer:</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">fromConsumerToLog</span> (<span class="i">consumer</span><span class="o">:</span><span class="i">EventConsumer</span>) <span class="o">=</span>
  <span class="i">consumer</span><span class="o">.</span><span class="i">OnStatistics</span><span class="o">.</span><span class="i">Add</span>(<span onmouseout="hideTip(event, 'fs7', 23)" onmouseover="showTip(event, 'fs7', 23)" class="i">Event</span><span class="o">.</span><span class="i">Statistics</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="i">toLog</span>)
  <span class="i">consumer</span><span class="o">.</span><span class="i">OnOffsetCommit</span><span class="o">.</span><span class="i">Add</span>(<span class="i">ofCommit</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs7', 24)" onmouseover="showTip(event, 'fs7', 24)" class="i">Event</span><span class="o">.</span><span class="i">OffsetCommit</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="i">toLog</span>)
  <span class="i">consumer</span><span class="o">.</span><span class="i">OnEndReached</span><span class="o">.</span><span class="i">Add</span>(<span class="i">ofTopicPartitionOffset</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs7', 25)" onmouseover="showTip(event, 'fs7', 25)" class="i">Event</span><span class="o">.</span><span class="i">EndReached</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="i">toLog</span>)
  <span class="i">consumer</span><span class="o">.</span><span class="i">OnPartitionsAssigned</span><span class="o">.</span><span class="i">Add</span>(<span class="i">ofTopicPartitionOffsets</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs7', 26)" onmouseover="showTip(event, 'fs7', 26)" class="i">Event</span><span class="o">.</span><span class="i">PartitionsAssigned</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="i">toLog</span>)
  <span class="i">consumer</span><span class="o">.</span><span class="i">OnPartitionsRevoked</span><span class="o">.</span><span class="i">Add</span>(<span class="i">ofTopicPartitionOffsets</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs7', 27)" onmouseover="showTip(event, 'fs7', 27)" class="i">Event</span><span class="o">.</span><span class="i">PartitionsRevoked</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="i">toLog</span>)
  <span class="i">consumer</span><span class="o">.</span><span class="i">OnConsumerError</span><span class="o">.</span><span class="i">Add</span>(<span onmouseout="hideTip(event, 'fs7', 28)" onmouseover="showTip(event, 'fs7', 28)" class="i">Event</span><span class="o">.</span><span class="i">ConsumerError</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="i">toLog</span>)
  <span class="i">consumer</span><span class="o">.</span><span class="i">OnError</span><span class="o">.</span><span class="i">Add</span>(<span class="i">ofError</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs7', 29)" onmouseover="showTip(event, 'fs7', 29)" class="i">Event</span><span class="o">.</span><span class="i">Error</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="i">toLog</span>)

<span class="k">let</span> <span class="i">fromProducerToLog</span> (<span class="i">source</span><span class="o">:</span><span class="i">ConsumerName</span>) (<span class="i">producer</span><span class="o">:</span><span class="i">Producer</span>) <span class="o">=</span>
  <span class="i">producer</span><span class="o">.</span><span class="i">OnError</span><span class="o">.</span><span class="i">Add</span>(<span class="i">ofError</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs7', 30)" onmouseover="showTip(event, 'fs7', 30)" class="i">Event</span><span class="o">.</span><span class="i">Error</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="i">toLog</span>)
  <span class="i">producer</span><span class="o">.</span><span class="i">OnStatistics</span><span class="o">.</span><span class="i">Add</span>(<span onmouseout="hideTip(event, 'fs7', 31)" onmouseover="showTip(event, 'fs7', 31)" class="i">Event</span><span class="o">.</span><span class="i">Statistics</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="i">toLog</span>)
</code></pre>
<h2>Configuration and Connection</h2>
<p>When you connect to RdKafka, you can configure any of the defaults in the underlying native library.
In particular, there are several settings you may want to consider:</p>
<ol>
<li>
a consumer <em>GroupId</em>, shared by all cooperating instances of a microservice
<ul>
<li>note for rdkafka 0.9.1 or earlier, setting GroupId on a producer may block Dispose()</li>
</ul>
</li>
<li>whether or not to <em>EnableAutoCommit</em> for tracking your current offset position</li>
<li>whether to save the offsets on the <em>broker</em> for coordination</li>
<li>if your Kafka cluster runs an idle connection reaper, disconnection messages will appear at even intervals when idle</li>
<li>a <em>metadata broker list</em> enables you to query metadata using the RdKafka C# wrapper</li>
<li>
where to start a <em>brand new</em> consumer group:
<ul>
<li><code>smallest</code> starts processing from the earliet offset in the topic</li>
<li><code>largest</code>, the default, starts from the newest message</li>
</ul>
</li>
</ol>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">connect</span> (<span class="i">brokerCsv</span><span class="o">:</span><span class="i">BrokerCsv</span>) (<span class="i">group</span><span class="o">:</span><span class="i">ConsumerName</span>) (<span class="i">autoCommit</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs12', 32)" onmouseover="showTip(event, 'fs12', 32)" class="i">bool</span>) <span class="o">=</span>
  <span class="k">let</span> <span class="i">config</span> <span class="o">=</span> <span class="k">new</span> <span class="i">Config</span>()
  <span class="i">config</span><span class="o">.</span><span class="i">GroupId</span> <span class="o">&lt;-</span> <span class="i">group</span>                                <span class="c">// (1)</span>
  <span class="i">config</span><span class="o">.</span><span class="i">StatisticsInterval</span> <span class="o">&lt;-</span> <span class="i">TimeSpan</span><span class="o">.</span><span class="i">FromSeconds</span>(<span class="n">1.0</span>)
  <span class="i">config</span><span class="o">.</span><span class="i">EnableAutoCommit</span> <span class="o">&lt;-</span> <span class="i">autoCommit</span>                  <span class="c">// (2)</span>
  <span class="i">config</span><span class="o">.</span>[<span class="s">&quot;offset.store.method&quot;</span>] <span class="o">&lt;-</span> <span class="s">&quot;broker&quot;</span>             <span class="c">// (3)</span>
  <span class="i">config</span><span class="o">.</span>[<span class="s">&quot;log.connection.close&quot;</span>] <span class="o">&lt;-</span> <span class="s">&quot;false&quot;</span>             <span class="c">// (4)</span>
  <span class="i">config</span><span class="o">.</span>[<span class="s">&quot;metadata.broker.list&quot;</span>] <span class="o">&lt;-</span> <span class="i">brokerCsv</span>           <span class="c">// (5)</span>
  <span class="i">config</span><span class="o">.</span><span class="i">DefaultTopicConfig</span> <span class="o">&lt;-</span>
    <span class="k">let</span> <span class="i">topicConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="i">TopicConfig</span>()
    <span class="i">topicConfig</span><span class="o">.</span>[<span class="s">&quot;auto.offset.reset&quot;</span>] <span class="o">&lt;-</span> <span class="s">&quot;smallest&quot;</span>      <span class="c">// (6)</span>
    <span class="i">topicConfig</span>

  <span class="k">new</span> <span class="i">EventConsumer</span>(<span class="i">config</span>, <span class="i">brokerCsv</span>),
  <span class="k">new</span> <span class="i">Producer</span>(<span class="i">config</span>, <span class="i">brokerCsv</span>)
</code></pre>
<p>A partition key and payload can then be published to a topic.  The response
includes a partition and offset cposition onfirming the write.  Consider
<code>Encoding.UTF8.GetBytes</code> if your message is text.</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">publish</span> (<span class="i">brokerCsv</span><span class="o">:</span><span class="i">BrokerCsv</span>) (<span class="i">group</span><span class="o">:</span><span class="i">ConsumerName</span>) (<span class="i">topic</span><span class="o">:</span><span class="i">Topic</span>) <span class="o">=</span>
  <span class="k">let</span> <span class="i">consumer</span>,<span class="i">producer</span> <span class="o">=</span> <span class="i">connect</span> <span class="i">brokerCsv</span> <span class="i">group</span> <span class="k">false</span>
  <span class="k">let</span> <span class="i">topic</span> <span class="o">=</span> <span class="i">producer</span><span class="o">.</span><span class="i">Topic</span>(<span class="i">topic</span>)
  <span class="k">fun</span> (<span class="i">key</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs13', 33)" onmouseover="showTip(event, 'fs13', 33)" class="i">byte</span>[], <span class="i">payload</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs13', 34)" onmouseover="showTip(event, 'fs13', 34)" class="i">byte</span>[]) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs14', 35)" onmouseover="showTip(event, 'fs14', 35)" class="i">async</span> {
    <span class="k">let!</span> <span class="i">report</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs15', 36)" onmouseover="showTip(event, 'fs15', 36)" class="i">Async</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs16', 37)" onmouseover="showTip(event, 'fs16', 37)" class="i">AwaitTask</span>(<span class="i">topic</span><span class="o">.</span><span class="i">Produce</span>(<span class="i">payload</span><span class="o">=</span><span class="i">payload</span>,<span class="i">key</span><span class="o">=</span><span class="i">key</span>))
    <span class="k">return</span> <span class="i">report</span><span class="o">.</span><span class="i">Partition</span>, <span class="i">report</span><span class="o">.</span><span class="i">Offset</span>
  }
</code></pre>
<p>To consume, on partition assignment we select <code>Offset.Stored</code> - (6) that now defaults
to <code>smallest</code> if no stored offset exists.  Messages are then sent to the onMessage callback
once the topic subscription is started.</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">subscribeCallback</span> (<span class="i">brokerCsv</span><span class="o">:</span><span class="i">BrokerCsv</span>) (<span class="i">group</span><span class="o">:</span><span class="i">ConsumerName</span>) (<span class="i">topic</span><span class="o">:</span><span class="i">Topic</span>) (<span class="i">onMessage</span>) <span class="o">=</span>
  <span class="k">let</span> <span class="i">autoCommit</span> <span class="o">=</span> <span class="k">true</span>
  <span class="k">let</span> <span class="i">consumer</span>,<span class="i">producer</span> <span class="o">=</span> <span class="i">connect</span> <span class="i">brokerCsv</span> <span class="i">group</span> <span class="i">autoCommit</span>
  <span class="i">consumer</span><span class="o">.</span><span class="i">OnPartitionsAssigned</span><span class="o">.</span><span class="i">Add</span>(
    <span class="i">ofTopicPartitionOffsets</span>
    <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs8', 38)" onmouseover="showTip(event, 'fs8', 38)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs17', 39)" onmouseover="showTip(event, 'fs17', 39)" class="i">map</span> (<span class="k">fun</span> (<span class="i">t</span>,<span class="i">p</span>,<span class="i">o</span>) <span class="k">-&gt;</span> <span class="i">t</span>,<span class="i">p</span>,<span class="i">Offset</span><span class="o">.</span><span class="i">Stored</span>)
    <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs8', 40)" onmouseover="showTip(event, 'fs8', 40)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs17', 41)" onmouseover="showTip(event, 'fs17', 41)" class="i">map</span> <span class="i">TopicPartitionOffset</span>
    <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs18', 42)" onmouseover="showTip(event, 'fs18', 42)" class="i">Collections</span><span class="o">.</span><span class="i">Generic</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 43)" onmouseover="showTip(event, 'fs8', 43)" class="i">List</span><span class="o">&lt;</span>_<span class="o">&gt;</span>
    <span class="o">&gt;</span><span class="o">&gt;</span> <span class="i">consumer</span><span class="o">.</span><span class="i">Assign</span>)
  <span class="i">consumer</span><span class="o">.</span><span class="i">OnMessage</span><span class="o">.</span><span class="i">Add</span>(<span class="i">onMessage</span>)
  <span class="i">consumer</span><span class="o">.</span><span class="i">Subscribe</span>(<span class="k">new</span> <span onmouseout="hideTip(event, 'fs18', 44)" onmouseover="showTip(event, 'fs18', 44)" class="i">Collections</span><span class="o">.</span><span class="i">Generic</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 45)" onmouseover="showTip(event, 'fs8', 45)" class="i">List</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs4', 46)" onmouseover="showTip(event, 'fs4', 46)" class="i">string</span><span class="o">&gt;</span>([<span class="i">topic</span>]))
  <span class="i">consumer</span><span class="o">.</span><span class="i">Start</span>()
</code></pre>
<p>The above works quite well <em>assuming you process the message to completion within the callback</em>.</p>
<p>If you want to process larger batches of messages using a sequence instead, a blocking
collection can used to buffer incoming messages as they're received.  A sequence generator
is returned allowing the consumer to iterate or batch the topic's messages.</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">subscribeSeq</span> (<span class="i">brokerCsv</span><span class="o">:</span><span class="i">BrokerCsv</span>) (<span class="i">group</span><span class="o">:</span><span class="i">ConsumerName</span>) (<span class="i">topic</span><span class="o">:</span><span class="i">Topic</span>) <span class="o">=</span>
  <span class="k">let</span> <span class="i">autoCommit</span> <span class="o">=</span> <span class="k">true</span>
  <span class="k">let</span> <span class="i">consumer</span>,<span class="i">producer</span> <span class="o">=</span> <span class="i">connect</span> <span class="i">brokerCsv</span> <span class="i">group</span> <span class="i">autoCommit</span>
  <span class="i">consumer</span><span class="o">.</span><span class="i">OnPartitionsAssigned</span><span class="o">.</span><span class="i">Add</span>(
    <span class="i">ofTopicPartitionOffsets</span>
    <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs8', 47)" onmouseover="showTip(event, 'fs8', 47)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs17', 48)" onmouseover="showTip(event, 'fs17', 48)" class="i">map</span> (<span class="k">fun</span> (<span class="i">t</span>,<span class="i">p</span>,<span class="i">o</span>) <span class="k">-&gt;</span> <span class="i">t</span>,<span class="i">p</span>,<span class="i">Offset</span><span class="o">.</span><span class="i">Stored</span>)
    <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs8', 49)" onmouseover="showTip(event, 'fs8', 49)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs17', 50)" onmouseover="showTip(event, 'fs17', 50)" class="i">map</span> <span class="i">TopicPartitionOffset</span>
    <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs18', 51)" onmouseover="showTip(event, 'fs18', 51)" class="i">Collections</span><span class="o">.</span><span class="i">Generic</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 52)" onmouseover="showTip(event, 'fs8', 52)" class="i">List</span><span class="o">&lt;</span>_<span class="o">&gt;</span>
    <span class="o">&gt;</span><span class="o">&gt;</span> <span class="i">consumer</span><span class="o">.</span><span class="i">Assign</span>)

  <span class="k">let</span> <span class="i">buffer</span> <span class="o">=</span> <span class="n">3000</span>
  <span class="k">let</span> <span class="i">messages</span> <span class="o">=</span>
    <span class="k">new</span> <span onmouseout="hideTip(event, 'fs18', 53)" onmouseover="showTip(event, 'fs18', 53)" class="i">Collections</span><span class="o">.</span><span class="i">Concurrent</span><span class="o">.</span><span class="i">BlockingCollection</span><span class="o">&lt;</span><span class="i">Message</span><span class="o">&gt;</span>(
      <span class="k">new</span> <span onmouseout="hideTip(event, 'fs18', 54)" onmouseover="showTip(event, 'fs18', 54)" class="i">Collections</span><span class="o">.</span><span class="i">Concurrent</span><span class="o">.</span><span class="i">ConcurrentQueue</span><span class="o">&lt;</span><span class="i">Message</span><span class="o">&gt;</span>(), <span class="i">buffer</span>)
  <span class="i">consumer</span><span class="o">.</span><span class="i">OnMessage</span><span class="o">.</span><span class="i">Add</span>(<span class="i">messages</span><span class="o">.</span><span class="i">Add</span>) <span class="c">// &gt; 3000 messages in the buffer will hold/block the callback</span>
  <span class="i">consumer</span><span class="o">.</span><span class="i">Subscribe</span>(<span class="k">new</span> <span onmouseout="hideTip(event, 'fs18', 55)" onmouseover="showTip(event, 'fs18', 55)" class="i">Collections</span><span class="o">.</span><span class="i">Generic</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 56)" onmouseover="showTip(event, 'fs8', 56)" class="i">List</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs4', 57)" onmouseover="showTip(event, 'fs4', 57)" class="i">string</span><span class="o">&gt;</span>([<span class="i">topic</span>]))
  <span class="i">consumer</span><span class="o">.</span><span class="i">Start</span>()
  
  <span onmouseout="hideTip(event, 'fs9', 58)" onmouseover="showTip(event, 'fs9', 58)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs19', 59)" onmouseover="showTip(event, 'fs19', 59)" class="i">initInfinite</span>(<span class="k">fun</span> _ <span class="k">-&gt;</span>
    <span class="k">let</span> <span class="i">message</span> <span class="o">=</span> <span class="i">messages</span><span class="o">.</span><span class="i">Take</span>()
    <span class="i">message</span><span class="o">.</span><span class="i">Partition</span>, <span class="i">message</span><span class="o">.</span><span class="i">Offset</span>, <span class="i">message</span><span class="o">.</span><span class="i">Payload</span>)  <span class="c">// or AsyncSeq :)</span>
</code></pre>
<p>At this point, we make an important observation: the client may commit offsets
acknowledging that a message in the buffer has been processed <em>even though this
may not have been dequeued</em> yet.  From RdKafka's point of view it's complete,
however.</p>
<p>If you process messages sequentially on a single thread, using a buffer size of 1
is an adequate workaround.  However, if you're processing messages in larger groups
or with multiple threads (using <code>AsyncSeq.iterAsyncParallel</code>, for instance), you'll
want to manage offsets yourself.</p>
<h2>Manual Offsets</h2>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span class="i">Offsets</span> <span class="o">=</span>
  { <span class="i">Next</span> <span class="o">:</span> <span class="i">Offset</span> <span onmouseout="hideTip(event, 'fs20', 60)" onmouseover="showTip(event, 'fs20', 60)" class="i">option</span>       <span class="c">// the next offset to be committed</span>
    <span class="i">Active</span> <span class="o">:</span> <span class="i">Offset</span> <span onmouseout="hideTip(event, 'fs21', 61)" onmouseover="showTip(event, 'fs21', 61)" class="i">list</span>       <span class="c">// offsets of active messages (started processing)</span>
    <span class="i">Processed</span> <span class="o">:</span> <span class="i">Offset</span> <span onmouseout="hideTip(event, 'fs21', 62)" onmouseover="showTip(event, 'fs21', 62)" class="i">list</span> }  <span class="c">// offsets of processed messages newer than (&gt;) any active</span>
                               <span class="c">// message (e.g., still working on 4L, but 5L &amp; 6L are processed)</span>
    
<span class="c">// start a message, finish a message, update &quot;next&quot; offset to be committed</span>
[&lt;<span onmouseout="hideTip(event, 'fs22', 63)" onmouseover="showTip(event, 'fs22', 63)" class="i">CompilationRepresentation</span>(<span onmouseout="hideTip(event, 'fs23', 64)" onmouseover="showTip(event, 'fs23', 64)" class="i">CompilationRepresentationFlags</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs24', 65)" onmouseover="showTip(event, 'fs24', 65)" class="i">ModuleSuffix</span>)&gt;]
<span class="k">module</span> <span class="i">Offsets</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">private</span> <span class="i">update</span> <span class="o">=</span> <span class="k">function</span>
    | { <span class="i">Processed</span><span class="o">=</span>[] } <span class="k">as</span> <span class="i">x</span> <span class="k">-&gt;</span> <span class="i">x</span>
    | { <span class="i">Active</span><span class="o">=</span>[] } <span class="k">as</span> <span class="i">x</span> <span class="k">-&gt;</span> { <span class="i">x</span> <span class="k">with</span> <span class="i">Processed</span><span class="o">=</span>[]; <span class="i">Next</span><span class="o">=</span><span onmouseout="hideTip(event, 'fs8', 66)" onmouseover="showTip(event, 'fs8', 66)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs25', 67)" onmouseover="showTip(event, 'fs25', 67)" class="i">max</span> <span class="i">x</span><span class="o">.</span><span class="i">Processed</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs26', 68)" onmouseover="showTip(event, 'fs26', 68)" class="i">Some</span> }
    | <span class="i">x</span> <span class="k">-&gt;</span> <span class="i">x</span><span class="o">.</span><span class="i">Processed</span>
           <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs8', 69)" onmouseover="showTip(event, 'fs8', 69)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs27', 70)" onmouseover="showTip(event, 'fs27', 70)" class="i">partition</span> ((<span class="o">&gt;</span><span class="o">=</span>) (<span onmouseout="hideTip(event, 'fs8', 71)" onmouseover="showTip(event, 'fs8', 71)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs28', 72)" onmouseover="showTip(event, 'fs28', 72)" class="i">min</span> <span class="i">x</span><span class="o">.</span><span class="i">Active</span>))
           <span class="o">|&gt;</span> <span class="k">function</span> | [], _ <span class="k">-&gt;</span> <span class="i">x</span>
                       | <span class="i">c</span>, <span class="i">p</span> <span class="k">-&gt;</span> { <span class="i">x</span> <span class="k">with</span> <span class="i">Processed</span><span class="o">=</span><span class="i">p</span>; <span class="i">Next</span><span class="o">=</span><span onmouseout="hideTip(event, 'fs8', 73)" onmouseover="showTip(event, 'fs8', 73)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs25', 74)" onmouseover="showTip(event, 'fs25', 74)" class="i">max</span> <span class="i">c</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs26', 75)" onmouseover="showTip(event, 'fs26', 75)" class="i">Some</span> }
  <span class="k">let</span> <span class="i">start</span>  (<span class="i">x</span><span class="o">:</span><span class="i">Offset</span>) (<span class="i">xs</span><span class="o">:</span><span class="i">Offsets</span>) <span class="o">=</span> <span class="i">update</span> { <span class="i">xs</span> <span class="k">with</span> <span class="i">Active</span> <span class="o">=</span> <span class="i">x</span> <span class="o">::</span> <span class="i">xs</span><span class="o">.</span><span class="i">Active</span> }
  <span class="k">let</span> <span class="i">finish</span> (<span class="i">x</span><span class="o">:</span><span class="i">Offset</span>) (<span class="i">xs</span><span class="o">:</span><span class="i">Offsets</span>) <span class="o">=</span> <span class="i">update</span> { <span class="i">xs</span> <span class="k">with</span> <span class="i">Active</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs8', 76)" onmouseover="showTip(event, 'fs8', 76)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs29', 77)" onmouseover="showTip(event, 'fs29', 77)" class="i">filter</span> ((<span class="o">&lt;&gt;</span>) <span class="i">x</span>) <span class="i">xs</span><span class="o">.</span><span class="i">Active</span>
                                                        <span class="i">Processed</span> <span class="o">=</span> <span class="i">x</span> <span class="o">::</span> <span class="i">xs</span><span class="o">.</span><span class="i">Processed</span> }

              
    
<span class="k">type</span> <span class="i">Watermark</span> <span class="o">=</span>               <span class="c">// watermark high/low offset for each partition of a topic</span>
  { <span class="i">Topic</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs4', 78)" onmouseover="showTip(event, 'fs4', 78)" class="i">string</span>             <span class="c">// topic</span>
    <span class="i">Partition</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs5', 79)" onmouseover="showTip(event, 'fs5', 79)" class="i">int</span>            <span class="c">// partition of the topic</span>
    <span class="i">High</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs6', 80)" onmouseover="showTip(event, 'fs6', 80)" class="i">int64</span>               <span class="c">// the highest offset available in that partition</span>
    <span class="i">Low</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs6', 81)" onmouseover="showTip(event, 'fs6', 81)" class="i">int64</span> }              <span class="c">// the lowest offset available in that partition</span>

[&lt;<span onmouseout="hideTip(event, 'fs22', 82)" onmouseover="showTip(event, 'fs22', 82)" class="i">CompilationRepresentation</span>(<span onmouseout="hideTip(event, 'fs23', 83)" onmouseover="showTip(event, 'fs23', 83)" class="i">CompilationRepresentationFlags</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs24', 84)" onmouseover="showTip(event, 'fs24', 84)" class="i">ModuleSuffix</span>)&gt;]
<span class="k">module</span> <span class="i">Watermark</span> <span class="o">=</span>
  <span class="k">let</span> <span class="i">queryWithTimeout</span> (<span class="i">timeout</span>) (<span class="i">producer</span><span class="o">:</span><span class="i">Producer</span>) (<span class="i">consumer</span><span class="o">:</span><span class="i">Consumer</span>) (<span class="i">topic</span><span class="o">:</span><span class="i">Topic</span>) <span class="o">=</span>
    <span class="k">let</span> <span class="i">queryWatermark</span>(<span class="i">t</span>, <span class="i">p</span>) <span class="o">=</span>
      <span onmouseout="hideTip(event, 'fs14', 85)" onmouseover="showTip(event, 'fs14', 85)" class="i">async</span> {
        <span class="k">let!</span> <span class="i">w</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs15', 86)" onmouseover="showTip(event, 'fs15', 86)" class="i">Async</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs16', 87)" onmouseover="showTip(event, 'fs16', 87)" class="i">AwaitTask</span> <span class="o">&lt;|</span> <span class="i">consumer</span><span class="o">.</span><span class="i">QueryWatermarkOffsets</span>(<span class="i">TopicPartition</span>(<span class="i">t</span>, <span class="i">p</span>), <span class="i">timeout</span>)
        <span class="k">return</span> { <span class="i">Topic</span><span class="o">=</span><span class="i">t</span>; <span class="i">Partition</span><span class="o">=</span><span class="i">p</span>; <span class="i">High</span><span class="o">=</span><span class="i">w</span><span class="o">.</span><span class="i">High</span>; <span class="i">Low</span><span class="o">=</span><span class="i">w</span><span class="o">.</span><span class="i">Low</span> }
      }
    <span onmouseout="hideTip(event, 'fs14', 88)" onmouseover="showTip(event, 'fs14', 88)" class="i">async</span> {
      <span class="k">let</span> <span class="i">topic</span> <span class="o">=</span> <span class="i">producer</span><span class="o">.</span><span class="i">Topic</span>(<span class="i">topic</span>)
      <span class="k">let!</span> <span class="i">metadata</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs15', 89)" onmouseover="showTip(event, 'fs15', 89)" class="i">Async</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs16', 90)" onmouseover="showTip(event, 'fs16', 90)" class="i">AwaitTask</span> <span class="o">&lt;|</span> <span class="i">producer</span><span class="o">.</span><span class="i">Metadata</span>(<span class="i">onlyForTopic</span><span class="o">=</span><span class="i">topic</span>, <span class="i">timeout</span><span class="o">=</span><span class="i">timeout</span>)
      <span class="k">return!</span>
        <span class="i">metadata</span><span class="o">.</span><span class="i">Topics</span>
        <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs9', 91)" onmouseover="showTip(event, 'fs9', 91)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs30', 92)" onmouseover="showTip(event, 'fs30', 92)" class="i">collect</span>(<span class="k">fun</span> <span class="i">t</span> <span class="k">-&gt;</span> <span class="i">t</span><span class="o">.</span><span class="i">Partitions</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs9', 93)" onmouseover="showTip(event, 'fs9', 93)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs10', 94)" onmouseover="showTip(event, 'fs10', 94)" class="i">map</span> (<span class="k">fun</span> <span class="i">p</span> <span class="k">-&gt;</span> <span class="i">t</span><span class="o">.</span><span class="i">Topic</span>, <span class="i">p</span><span class="o">.</span><span class="i">PartitionId</span>))
        <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs9', 95)" onmouseover="showTip(event, 'fs9', 95)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs31', 96)" onmouseover="showTip(event, 'fs31', 96)" class="i">sort</span>
        <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs9', 97)" onmouseover="showTip(event, 'fs9', 97)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs10', 98)" onmouseover="showTip(event, 'fs10', 98)" class="i">map</span> <span class="i">queryWatermark</span>
        <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs15', 99)" onmouseover="showTip(event, 'fs15', 99)" class="i">Async</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs32', 100)" onmouseover="showTip(event, 'fs32', 100)" class="i">Parallel</span> <span class="c">// use open source AsyncSeq, instead :)</span>
    }
                     
<span class="k">type</span> <span class="i">Checkpoint</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs8', 101)" onmouseover="showTip(event, 'fs8', 101)" class="i">List</span><span class="o">&lt;</span><span class="i">Partition</span><span class="o">*</span><span class="i">Offset</span><span class="o">&gt;</span>

[&lt;<span onmouseout="hideTip(event, 'fs22', 102)" onmouseover="showTip(event, 'fs22', 102)" class="i">CompilationRepresentation</span>(<span onmouseout="hideTip(event, 'fs23', 103)" onmouseover="showTip(event, 'fs23', 103)" class="i">CompilationRepresentationFlags</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs24', 104)" onmouseover="showTip(event, 'fs24', 104)" class="i">ModuleSuffix</span>)&gt;]
<span class="k">module</span> <span class="i">Checkpoint</span> <span class="o">=</span>
  <span class="k">let</span> <span class="i">queryWithTimeout</span> (<span class="i">timeout</span>) (<span class="i">producer</span><span class="o">:</span><span class="i">Producer</span>) (<span class="i">consumer</span><span class="o">:</span><span class="i">Consumer</span>) (<span class="i">topic</span><span class="o">:</span><span class="i">Topic</span>) <span class="o">:</span> <span onmouseout="hideTip(event, 'fs15', 105)" onmouseover="showTip(event, 'fs15', 105)" class="i">Async</span><span class="o">&lt;</span><span class="i">Checkpoint</span><span class="o">&gt;</span> <span class="o">=</span>
    <span onmouseout="hideTip(event, 'fs14', 106)" onmouseover="showTip(event, 'fs14', 106)" class="i">async</span> {
      <span class="k">let!</span> <span class="i">metadata</span> <span class="o">=</span> 
        <span class="i">producer</span><span class="o">.</span><span class="i">Metadata</span>(<span class="i">onlyForTopic</span><span class="o">=</span><span class="i">producer</span><span class="o">.</span><span class="i">Topic</span>(<span class="i">topic</span>), <span class="i">timeout</span><span class="o">=</span><span class="i">timeout</span>)
        <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs15', 107)" onmouseover="showTip(event, 'fs15', 107)" class="i">Async</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs16', 108)" onmouseover="showTip(event, 'fs16', 108)" class="i">AwaitTask</span>
      <span class="k">let</span> <span class="i">partitions</span> <span class="o">=</span>
        <span class="i">metadata</span><span class="o">.</span><span class="i">Topics</span>
        <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs9', 109)" onmouseover="showTip(event, 'fs9', 109)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs30', 110)" onmouseover="showTip(event, 'fs30', 110)" class="i">collect</span>(<span class="k">fun</span> <span class="i">t</span> <span class="k">-&gt;</span> <span class="i">t</span><span class="o">.</span><span class="i">Partitions</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs9', 111)" onmouseover="showTip(event, 'fs9', 111)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs10', 112)" onmouseover="showTip(event, 'fs10', 112)" class="i">map</span> (<span class="k">fun</span> <span class="i">p</span> <span class="k">-&gt;</span> <span class="i">t</span><span class="o">.</span><span class="i">Topic</span>, <span class="i">p</span><span class="o">.</span><span class="i">PartitionId</span>))
        <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs9', 113)" onmouseover="showTip(event, 'fs9', 113)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs31', 114)" onmouseover="showTip(event, 'fs31', 114)" class="i">sort</span>
        <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs9', 115)" onmouseover="showTip(event, 'fs9', 115)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs10', 116)" onmouseover="showTip(event, 'fs10', 116)" class="i">map</span> (<span class="k">fun</span> (<span class="i">t</span>,<span class="i">p</span>) <span class="k">-&gt;</span> <span class="k">new</span> <span class="i">TopicPartition</span>(<span class="i">t</span>,<span class="i">p</span>))
      <span class="k">let!</span> <span class="i">committed</span> <span class="o">=</span>
        <span class="i">consumer</span><span class="o">.</span><span class="i">Committed</span>(<span class="k">new</span> <span onmouseout="hideTip(event, 'fs18', 117)" onmouseover="showTip(event, 'fs18', 117)" class="i">Collections</span><span class="o">.</span><span class="i">Generic</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 118)" onmouseover="showTip(event, 'fs8', 118)" class="i">List</span><span class="o">&lt;</span>_<span class="o">&gt;</span>(<span class="i">partitions</span>), <span class="i">timeout</span>)
        <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs15', 119)" onmouseover="showTip(event, 'fs15', 119)" class="i">Async</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs16', 120)" onmouseover="showTip(event, 'fs16', 120)" class="i">AwaitTask</span>
      <span class="k">return</span>
        <span class="i">committed</span>
        <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs9', 121)" onmouseover="showTip(event, 'fs9', 121)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs10', 122)" onmouseover="showTip(event, 'fs10', 122)" class="i">map</span> (<span class="k">fun</span> <span class="i">tpo</span> <span class="k">-&gt;</span> <span class="i">tpo</span><span class="o">.</span><span class="i">Partition</span>, <span class="i">tpo</span><span class="o">.</span><span class="i">Offset</span>)
        <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs9', 123)" onmouseover="showTip(event, 'fs9', 123)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs33', 124)" onmouseover="showTip(event, 'fs33', 124)" class="i">sortBy</span> <span onmouseout="hideTip(event, 'fs34', 125)" onmouseover="showTip(event, 'fs34', 125)" class="i">fst</span>
        <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs9', 126)" onmouseover="showTip(event, 'fs9', 126)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs11', 127)" onmouseover="showTip(event, 'fs11', 127)" class="i">toList</span>
    }

<span class="k">module</span> <span class="i">OffsetMonitor</span> <span class="o">=</span>
  <span class="k">let</span> <span class="i">assign</span> _ <span class="o">=</span> ()
  <span class="k">let</span> <span class="i">revoke</span> _ <span class="o">=</span> ()
    
<span class="k">let</span> <span class="i">subscribe</span> (<span class="i">brokerCsv</span><span class="o">:</span><span class="i">BrokerCsv</span>) (<span class="i">group</span><span class="o">:</span><span class="i">ConsumerName</span>) (<span class="i">topic</span><span class="o">:</span><span class="i">Topic</span>) <span class="o">=</span>
  <span class="k">let</span> <span class="i">autoCommit</span> <span class="o">=</span> <span class="k">false</span>
  <span class="k">let</span> <span class="i">consumer</span>,<span class="i">producer</span> <span class="o">=</span> <span class="i">connect</span> <span class="i">brokerCsv</span> <span class="i">group</span> <span class="i">autoCommit</span>
  <span class="i">consumer</span><span class="o">.</span><span class="i">OnPartitionsAssigned</span><span class="o">.</span><span class="i">Add</span>(
    <span class="i">ofTopicPartitionOffsets</span>
    <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs8', 128)" onmouseover="showTip(event, 'fs8', 128)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs17', 129)" onmouseover="showTip(event, 'fs17', 129)" class="i">map</span> (<span class="k">fun</span> (<span class="i">t</span>,<span class="i">p</span>,<span class="i">o</span>) <span class="k">-&gt;</span> <span class="i">t</span>,<span class="i">p</span>,<span class="i">Offset</span><span class="o">.</span><span class="i">Stored</span>)
    <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs8', 130)" onmouseover="showTip(event, 'fs8', 130)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs17', 131)" onmouseover="showTip(event, 'fs17', 131)" class="i">map</span> <span class="i">TopicPartitionOffset</span>
    <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs18', 132)" onmouseover="showTip(event, 'fs18', 132)" class="i">Collections</span><span class="o">.</span><span class="i">Generic</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 133)" onmouseover="showTip(event, 'fs8', 133)" class="i">List</span><span class="o">&lt;</span>_<span class="o">&gt;</span>
    <span class="o">&gt;</span><span class="o">&gt;</span> <span class="i">consumer</span><span class="o">.</span><span class="i">Assign</span>)

  <span class="i">consumer</span><span class="o">.</span><span class="i">OnPartitionsAssigned</span><span class="o">.</span><span class="i">Add</span>(<span class="i">ofTopicPartitionOffsets</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="i">OffsetMonitor</span><span class="o">.</span><span class="i">assign</span>)
  <span class="i">consumer</span><span class="o">.</span><span class="i">OnPartitionsRevoked</span><span class="o">.</span><span class="i">Add</span>(<span class="i">ofTopicPartitionOffsets</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="i">OffsetMonitor</span><span class="o">.</span><span class="i">revoke</span>)

  <span class="k">let</span> <span class="i">messageSeq</span> <span class="o">=</span>
    <span class="k">let</span> <span class="i">buffer</span> <span class="o">=</span> <span class="n">3000</span>
    <span class="k">let</span> <span class="i">messages</span> <span class="o">=</span>
      <span class="k">new</span> <span onmouseout="hideTip(event, 'fs18', 134)" onmouseover="showTip(event, 'fs18', 134)" class="i">Collections</span><span class="o">.</span><span class="i">Concurrent</span><span class="o">.</span><span class="i">BlockingCollection</span><span class="o">&lt;</span><span class="i">Message</span><span class="o">&gt;</span>(
        <span class="k">new</span> <span onmouseout="hideTip(event, 'fs18', 135)" onmouseover="showTip(event, 'fs18', 135)" class="i">Collections</span><span class="o">.</span><span class="i">Concurrent</span><span class="o">.</span><span class="i">ConcurrentQueue</span><span class="o">&lt;</span><span class="i">Message</span><span class="o">&gt;</span>(), <span class="i">buffer</span>)
    <span class="i">consumer</span><span class="o">.</span><span class="i">OnMessage</span><span class="o">.</span><span class="i">Add</span>(<span class="i">messages</span><span class="o">.</span><span class="i">Add</span>)
    <span onmouseout="hideTip(event, 'fs9', 136)" onmouseover="showTip(event, 'fs9', 136)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs19', 137)" onmouseover="showTip(event, 'fs19', 137)" class="i">initInfinite</span>(<span class="k">fun</span> _ <span class="k">-&gt;</span> <span class="i">messages</span><span class="o">.</span><span class="i">Take</span>())
  <span class="i">consumer</span><span class="o">.</span><span class="i">Subscribe</span>(<span class="k">new</span> <span onmouseout="hideTip(event, 'fs18', 138)" onmouseover="showTip(event, 'fs18', 138)" class="i">Collections</span><span class="o">.</span><span class="i">Generic</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 139)" onmouseover="showTip(event, 'fs8', 139)" class="i">List</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs4', 140)" onmouseover="showTip(event, 'fs4', 140)" class="i">string</span><span class="o">&gt;</span>([<span class="i">topic</span>]))
  <span class="i">consumer</span><span class="o">.</span><span class="i">Start</span>()
  
  ()

  
</code></pre>


<div class="tip" id="fs1">namespace System</div>
<div class="tip" id="fs2">namespace System.Collections</div>
<div class="tip" id="fs3">namespace System.Collections.Concurrent</div>
<div class="tip" id="fs4">Multiple items<br />val string : value:&#39;T -&gt; string<br /><br />Full name: Microsoft.FSharp.Core.Operators.string<br /><br />--------------------<br />type string = System.String<br /><br />Full name: Microsoft.FSharp.Core.string</div>
<div class="tip" id="fs5">Multiple items<br />val int : value:&#39;T -&gt; int (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.int<br /><br />--------------------<br />type int = int32<br /><br />Full name: Microsoft.FSharp.Core.int<br /><br />--------------------<br />type int&lt;&#39;Measure&gt; = int<br /><br />Full name: Microsoft.FSharp.Core.int&lt;_&gt;</div>
<div class="tip" id="fs6">Multiple items<br />val int64 : value:&#39;T -&gt; int64 (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.int64<br /><br />--------------------<br />type int64 = System.Int64<br /><br />Full name: Microsoft.FSharp.Core.int64<br /><br />--------------------<br />type int64&lt;&#39;Measure&gt; = int64<br /><br />Full name: Microsoft.FSharp.Core.int64&lt;_&gt;</div>
<div class="tip" id="fs7">Multiple items<br />module Event<br /><br />from Microsoft.FSharp.Control<br /><br />--------------------<br />type Event&lt;&#39;T&gt; =<br />&#160;&#160;new : unit -&gt; Event&lt;&#39;T&gt;<br />&#160;&#160;member Trigger : arg:&#39;T -&gt; unit<br />&#160;&#160;member Publish : IEvent&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Control.Event&lt;_&gt;<br /><br />--------------------<br />type Event&lt;&#39;Delegate,&#39;Args (requires delegate and &#39;Delegate :&gt; Delegate)&gt; =<br />&#160;&#160;new : unit -&gt; Event&lt;&#39;Delegate,&#39;Args&gt;<br />&#160;&#160;member Trigger : sender:obj * args:&#39;Args -&gt; unit<br />&#160;&#160;member Publish : IEvent&lt;&#39;Delegate,&#39;Args&gt;<br /><br />Full name: Microsoft.FSharp.Control.Event&lt;_,_&gt;<br /><br />--------------------<br />new : unit -&gt; Event&lt;&#39;T&gt;<br /><br />--------------------<br />new : unit -&gt; Event&lt;&#39;Delegate,&#39;Args&gt;</div>
<div class="tip" id="fs8">Multiple items<br />module List<br /><br />from Microsoft.FSharp.Collections<br /><br />--------------------<br />type List&lt;&#39;T&gt; =<br />&#160;&#160;| ( [] )<br />&#160;&#160;| ( :: ) of Head: &#39;T * Tail: &#39;T list<br />&#160;&#160;interface IEnumerable<br />&#160;&#160;interface IEnumerable&lt;&#39;T&gt;<br />&#160;&#160;member GetSlice : startIndex:int option * endIndex:int option -&gt; &#39;T list<br />&#160;&#160;member Head : &#39;T<br />&#160;&#160;member IsEmpty : bool<br />&#160;&#160;member Item : index:int -&gt; &#39;T with get<br />&#160;&#160;member Length : int<br />&#160;&#160;member Tail : &#39;T list<br />&#160;&#160;static member Cons : head:&#39;T * tail:&#39;T list -&gt; &#39;T list<br />&#160;&#160;static member Empty : &#39;T list<br /><br />Full name: Microsoft.FSharp.Collections.List&lt;_&gt;</div>
<div class="tip" id="fs9">module Seq<br /><br />from Microsoft.FSharp.Collections</div>
<div class="tip" id="fs10">val map : mapping:(&#39;T -&gt; &#39;U) -&gt; source:seq&lt;&#39;T&gt; -&gt; seq&lt;&#39;U&gt;<br /><br />Full name: Microsoft.FSharp.Collections.Seq.map</div>
<div class="tip" id="fs11">val toList : source:seq&lt;&#39;T&gt; -&gt; &#39;T list<br /><br />Full name: Microsoft.FSharp.Collections.Seq.toList</div>
<div class="tip" id="fs12">type bool = System.Boolean<br /><br />Full name: Microsoft.FSharp.Core.bool</div>
<div class="tip" id="fs13">Multiple items<br />val byte : value:&#39;T -&gt; byte (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.byte<br /><br />--------------------<br />type byte = System.Byte<br /><br />Full name: Microsoft.FSharp.Core.byte</div>
<div class="tip" id="fs14">val async : AsyncBuilder<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.async</div>
<div class="tip" id="fs15">Multiple items<br />type Async<br />static member AsBeginEnd : computation:(&#39;Arg -&gt; Async&lt;&#39;T&gt;) -&gt; (&#39;Arg * AsyncCallback * obj -&gt; IAsyncResult) * (IAsyncResult -&gt; &#39;T) * (IAsyncResult -&gt; unit)<br />static member AwaitEvent : event:IEvent&lt;&#39;Del,&#39;T&gt; * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt; (requires delegate and &#39;Del :&gt; Delegate)<br />static member AwaitIAsyncResult : iar:IAsyncResult * ?millisecondsTimeout:int -&gt; Async&lt;bool&gt;<br />static member AwaitTask : task:Task -&gt; Async&lt;unit&gt;<br />static member AwaitTask : task:Task&lt;&#39;T&gt; -&gt; Async&lt;&#39;T&gt;<br />static member AwaitWaitHandle : waitHandle:WaitHandle * ?millisecondsTimeout:int -&gt; Async&lt;bool&gt;<br />static member CancelDefaultToken : unit -&gt; unit<br />static member Catch : computation:Async&lt;&#39;T&gt; -&gt; Async&lt;Choice&lt;&#39;T,exn&gt;&gt;<br />static member FromBeginEnd : beginAction:(AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member FromBeginEnd : arg:&#39;Arg1 * beginAction:(&#39;Arg1 * AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member FromBeginEnd : arg1:&#39;Arg1 * arg2:&#39;Arg2 * beginAction:(&#39;Arg1 * &#39;Arg2 * AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member FromBeginEnd : arg1:&#39;Arg1 * arg2:&#39;Arg2 * arg3:&#39;Arg3 * beginAction:(&#39;Arg1 * &#39;Arg2 * &#39;Arg3 * AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member FromContinuations : callback:((&#39;T -&gt; unit) * (exn -&gt; unit) * (OperationCanceledException -&gt; unit) -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member Ignore : computation:Async&lt;&#39;T&gt; -&gt; Async&lt;unit&gt;<br />static member OnCancel : interruption:(unit -&gt; unit) -&gt; Async&lt;IDisposable&gt;<br />static member Parallel : computations:seq&lt;Async&lt;&#39;T&gt;&gt; -&gt; Async&lt;&#39;T []&gt;<br />static member RunSynchronously : computation:Async&lt;&#39;T&gt; * ?timeout:int * ?cancellationToken:CancellationToken -&gt; &#39;T<br />static member Sleep : millisecondsDueTime:int -&gt; Async&lt;unit&gt;<br />static member Start : computation:Async&lt;unit&gt; * ?cancellationToken:CancellationToken -&gt; unit<br />static member StartAsTask : computation:Async&lt;&#39;T&gt; * ?taskCreationOptions:TaskCreationOptions * ?cancellationToken:CancellationToken -&gt; Task&lt;&#39;T&gt;<br />static member StartChild : computation:Async&lt;&#39;T&gt; * ?millisecondsTimeout:int -&gt; Async&lt;Async&lt;&#39;T&gt;&gt;<br />static member StartChildAsTask : computation:Async&lt;&#39;T&gt; * ?taskCreationOptions:TaskCreationOptions -&gt; Async&lt;Task&lt;&#39;T&gt;&gt;<br />static member StartImmediate : computation:Async&lt;unit&gt; * ?cancellationToken:CancellationToken -&gt; unit<br />static member StartWithContinuations : computation:Async&lt;&#39;T&gt; * continuation:(&#39;T -&gt; unit) * exceptionContinuation:(exn -&gt; unit) * cancellationContinuation:(OperationCanceledException -&gt; unit) * ?cancellationToken:CancellationToken -&gt; unit<br />static member SwitchToContext : syncContext:SynchronizationContext -&gt; Async&lt;unit&gt;<br />static member SwitchToNewThread : unit -&gt; Async&lt;unit&gt;<br />static member SwitchToThreadPool : unit -&gt; Async&lt;unit&gt;<br />static member TryCancelled : computation:Async&lt;&#39;T&gt; * compensation:(OperationCanceledException -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member CancellationToken : Async&lt;CancellationToken&gt;<br />static member DefaultCancellationToken : CancellationToken<br /><br />Full name: Microsoft.FSharp.Control.Async<br /><br />--------------------<br />type Async&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Control.Async&lt;_&gt;</div>
<div class="tip" id="fs16">static member Async.AwaitTask : task:System.Threading.Tasks.Task -&gt; Async&lt;unit&gt;<br />static member Async.AwaitTask : task:System.Threading.Tasks.Task&lt;&#39;T&gt; -&gt; Async&lt;&#39;T&gt;</div>
<div class="tip" id="fs17">val map : mapping:(&#39;T -&gt; &#39;U) -&gt; list:&#39;T list -&gt; &#39;U list<br /><br />Full name: Microsoft.FSharp.Collections.List.map</div>
<div class="tip" id="fs18">namespace Microsoft.FSharp.Collections</div>
<div class="tip" id="fs19">val initInfinite : initializer:(int -&gt; &#39;T) -&gt; seq&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.Seq.initInfinite</div>
<div class="tip" id="fs20">type &#39;T option = Option&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Core.option&lt;_&gt;</div>
<div class="tip" id="fs21">type &#39;T list = List&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.list&lt;_&gt;</div>
<div class="tip" id="fs22">Multiple items<br />type CompilationRepresentationAttribute =<br />&#160;&#160;inherit Attribute<br />&#160;&#160;new : flags:CompilationRepresentationFlags -&gt; CompilationRepresentationAttribute<br />&#160;&#160;member Flags : CompilationRepresentationFlags<br /><br />Full name: Microsoft.FSharp.Core.CompilationRepresentationAttribute<br /><br />--------------------<br />new : flags:CompilationRepresentationFlags -&gt; CompilationRepresentationAttribute</div>
<div class="tip" id="fs23">type CompilationRepresentationFlags =<br />&#160;&#160;|  None  =  0<br />&#160;&#160;|  Static  =  1<br />&#160;&#160;|  Instance  =  2<br />&#160;&#160;|  ModuleSuffix  =  4<br />&#160;&#160;|  UseNullAsTrueValue  =  8<br />&#160;&#160;|  Event  =  16<br /><br />Full name: Microsoft.FSharp.Core.CompilationRepresentationFlags</div>
<div class="tip" id="fs24">CompilationRepresentationFlags.ModuleSuffix: CompilationRepresentationFlags = 4</div>
<div class="tip" id="fs25">val max : list:&#39;T list -&gt; &#39;T (requires comparison)<br /><br />Full name: Microsoft.FSharp.Collections.List.max</div>
<div class="tip" id="fs26">union case Option.Some: Value: &#39;T -&gt; Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs27">val partition : predicate:(&#39;T -&gt; bool) -&gt; list:&#39;T list -&gt; &#39;T list * &#39;T list<br /><br />Full name: Microsoft.FSharp.Collections.List.partition</div>
<div class="tip" id="fs28">val min : list:&#39;T list -&gt; &#39;T (requires comparison)<br /><br />Full name: Microsoft.FSharp.Collections.List.min</div>
<div class="tip" id="fs29">val filter : predicate:(&#39;T -&gt; bool) -&gt; list:&#39;T list -&gt; &#39;T list<br /><br />Full name: Microsoft.FSharp.Collections.List.filter</div>
<div class="tip" id="fs30">val collect : mapping:(&#39;T -&gt; #seq&lt;&#39;U&gt;) -&gt; source:seq&lt;&#39;T&gt; -&gt; seq&lt;&#39;U&gt;<br /><br />Full name: Microsoft.FSharp.Collections.Seq.collect</div>
<div class="tip" id="fs31">val sort : source:seq&lt;&#39;T&gt; -&gt; seq&lt;&#39;T&gt; (requires comparison)<br /><br />Full name: Microsoft.FSharp.Collections.Seq.sort</div>
<div class="tip" id="fs32">static member Async.Parallel : computations:seq&lt;Async&lt;&#39;T&gt;&gt; -&gt; Async&lt;&#39;T []&gt;</div>
<div class="tip" id="fs33">val sortBy : projection:(&#39;T -&gt; &#39;Key) -&gt; source:seq&lt;&#39;T&gt; -&gt; seq&lt;&#39;T&gt; (requires comparison)<br /><br />Full name: Microsoft.FSharp.Collections.Seq.sortBy</div>
<div class="tip" id="fs34">val fst : tuple:(&#39;T1 * &#39;T2) -&gt; &#39;T1<br /><br />Full name: Microsoft.FSharp.Core.Operators.fst</div>
